From 0ce058fa149ae8c94971aad642c25a782de62d6c Mon Sep 17 00:00:00 2001
From: Valentin Raevsky <valentin@compulab.co.il>
Date: Wed, 19 Apr 2023 18:36:33 +0300
Subject: [PATCH] panel: timings logics update

Signed-off-by: Valentin Raevsky <valentin@compulab.co.il>
---
 .../gpu/drm/panel/panel-startek-ili9881c.c    | 55 ++++++++++---------
 1 file changed, 28 insertions(+), 27 deletions(-)

diff --git a/drivers/gpu/drm/panel/panel-startek-ili9881c.c b/drivers/gpu/drm/panel/panel-startek-ili9881c.c
index 7d75dbd7cffb..79e688b6b615 100644
--- a/drivers/gpu/drm/panel/panel-startek-ili9881c.c
+++ b/drivers/gpu/drm/panel/panel-startek-ili9881c.c
@@ -22,18 +22,11 @@
 
 #include <linux/of_device.h>
 #include <linux/of_gpio.h>
+#include <video/of_display_timing.h>
 
 #include <video/mipi_display.h>
-
-#define   LCD_XSIZE_TFT   720
-#define   LCD_YSIZE_TFT   1280
-#define   CLOCK           60000
-#define   LCD_VBPD        20
-#define   LCD_VFPD        10
-#define   LCD_VSPW        10
-#define   LCD_HBPD        30
-#define   LCD_HFPD        10
-#define   LCD_HSPW        20
+#include <video/display_timing.h>
+#include <video/videomode.h>
 
 struct ili9881c {
     struct drm_panel	panel;
@@ -497,20 +490,20 @@ static int ili9881c_unprepare(struct drm_panel *panel)
     return 0;
 }
 
-static const struct drm_display_mode bananapi_default_mode = {
-    .clock	= CLOCK,
-
-    .hdisplay	= LCD_XSIZE_TFT,
-    .hsync_start= LCD_XSIZE_TFT + LCD_HFPD,
-    .hsync_end	= LCD_XSIZE_TFT + LCD_HFPD + LCD_HSPW,
-    .htotal	= LCD_XSIZE_TFT + LCD_HFPD + LCD_HSPW + LCD_HBPD,
-
-    .vdisplay	= LCD_YSIZE_TFT,
-    .vsync_start= LCD_YSIZE_TFT + LCD_VFPD,
-    .vsync_end	= LCD_YSIZE_TFT + LCD_VFPD + LCD_VSPW,
-    .vtotal	= LCD_YSIZE_TFT + LCD_VFPD + LCD_VSPW + LCD_VBPD,
+static struct display_timing banana_timing = {
+    .pixelclock = { 60000000, 60000000, 60000000 },
+    .hactive = { 720, 720, 720 },
+    .hfront_porch = { 20, 20, 20 },
+    .hback_porch = { 10, 10, 10 },
+    .hsync_len = { 10, 10, 10 },
+    .vactive = { 1280, 1280, 1280 },
+    .vfront_porch = { 10, 10, 10 },
+    .vback_porch = { 30, 30, 30 },
+    .vsync_len = { 20, 20, 20 },
+    .flags = DISPLAY_FLAGS_VSYNC_LOW | DISPLAY_FLAGS_HSYNC_LOW | DISPLAY_FLAGS_DE_LOW,
 };
 
+
 static int ili9881c_get_modes(struct drm_panel *panel,
 		struct drm_connector *connector)
 {
@@ -518,14 +511,17 @@ static int ili9881c_get_modes(struct drm_panel *panel,
     struct drm_display_mode *mode;
     int ret;
 
-    mode = drm_mode_duplicate(connector->dev, &bananapi_default_mode);
+    const struct display_timing *dt = &banana_timing;
+    struct videomode vm;
+
+    videomode_from_timing(dt, &vm);
+    mode = drm_mode_create(connector->dev);
     if (!mode) {
-        dev_err(&ctx->dsi->dev, "failed to add mode %ux%ux@%u\n",
-            bananapi_default_mode.hdisplay,
-            bananapi_default_mode.vdisplay,
-            drm_mode_vrefresh(&bananapi_default_mode));
+        dev_err(&ctx->dsi->dev, "failed to add mode %dx%d\n",
+            dt->hactive.min, dt->vactive.min);
         return -ENOMEM;
     }
+    drm_display_mode_from_videomode(&vm, mode);
 
     drm_mode_set_name(mode);
 
@@ -592,6 +588,11 @@ static int ili9881c_dsi_probe(struct mipi_dsi_device *dsi)
             return -EPROBE_DEFER;
     }
 
+    if (of_get_display_timing(dsi->dev.of_node, "panel-timing", &banana_timing))
+        dev_notice(&dsi->dev, "Couldn't get panel timing from dtb, use driver settings\n");
+    else
+        dev_notice(&dsi->dev, "Use panel timing from dtb\n");
+
     of_property_read_u32(dsi->dev.of_node, "dsi-lanes", &lanes);
     drm_panel_add(&ctx->panel);
 
-- 
2.17.1

