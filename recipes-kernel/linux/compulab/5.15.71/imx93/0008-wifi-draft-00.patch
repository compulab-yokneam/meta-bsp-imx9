From 05b7739a0afc7fe01ed2e008b7c49bda54bb8ec4 Mon Sep 17 00:00:00 2001
From: Valentin Raevsky <valentin@compulab.co.il>
Date: Fri, 7 Apr 2023 20:00:25 +0300
Subject: [PATCH] wifi: draft #00

Signed-off-by: Valentin Raevsky <valentin@compulab.co.il>
---
 arch/arm64/boot/dts/compulab/ucm-imx93.dts | 44 ++++++++++++++++------
 arch/arm64/configs/ucm-imx93_defconfig     |  2 +
 2 files changed, 34 insertions(+), 12 deletions(-)

diff --git a/arch/arm64/boot/dts/compulab/ucm-imx93.dts b/arch/arm64/boot/dts/compulab/ucm-imx93.dts
index 43cd7b4c07f3..e5efc6c586eb 100644
--- a/arch/arm64/boot/dts/compulab/ucm-imx93.dts
+++ b/arch/arm64/boot/dts/compulab/ucm-imx93.dts
@@ -117,9 +117,24 @@
 		regulator-max-microvolt = <1800000>;
 	};
 
+#if 0
 	usdhc3_pwrseq: usdhc3_pwrseq {
 		compatible = "mmc-pwrseq-simple";
+		reset-gpios = <&gpio1 17 GPIO_ACTIVE_LOW>;
 	};
+#else
+	reg_usdhc3_vmmc: regulator-usdhc3 {
+		compatible = "regulator-fixed";
+		pinctrl-names = "default";
+		pinctrl-0 = <&pinctrl_reg_usdhc3_vmmc>;
+		regulator-name = "usdhc3_VSD_3V3";
+		regulator-min-microvolt = <3300000>;
+		regulator-max-microvolt = <3300000>;
+		gpio = <&gpio1 17 GPIO_ACTIVE_HIGH>;
+		enable-active-high;
+		regulator-always-on;
+	};
+#endif
 
 	sound-micfil {
 		compatible = "fsl,imx-audio-card";
@@ -186,7 +201,7 @@
 	assigned-clock-parents = <&clk IMX93_CLK_AUDIO_PLL>;
 	assigned-clock-rates = <12288000>;
 	fsl,sai-mclk-direction-output;
-	status = "okay";
+	status = "disable";
 };
 
 &micfil {
@@ -549,24 +564,21 @@
 };
 
 &usdhc3 {
+	#address-cells = <1>;
+	#size-cells = <0>;
 	pinctrl-names = "default", "state_100mhz", "state_200mhz";
 	pinctrl-0 = <&pinctrl_usdhc3>, <&pinctrl_usdhc3_wlan>;
 	pinctrl-1 = <&pinctrl_usdhc3>, <&pinctrl_usdhc3_wlan>;
 	pinctrl-2 = <&pinctrl_usdhc3>, <&pinctrl_usdhc3_wlan>;
-	mmc-pwrseq = <&usdhc3_pwrseq>;
-	/* pinctrl-assert-gpios = <&pcal6524 13 GPIO_ACTIVE_HIGH>;*/
 	bus-width = <4>;
-	keep-power-in-suspend;
 	non-removable;
 	wakeup-source;
-	fsl,sdio-async-interrupt-enabled;
-	status = "disabled";
+	no-1-8-v;
+	status = "okay";
 
-	wifi_wake_host {
-		compatible = "nxp,wifi-wake-host";
-		interrupt-parent = <&gpio3>;
-		interrupts = <26 IRQ_TYPE_LEVEL_LOW>;
-		interrupt-names = "host-wake";
+	mwifiex: wifi@1 {
+		compatible = "marvell,sd8997";
+		reg = <1>;
 	};
 };
 
@@ -712,9 +724,17 @@
 		>;
 	};
 
+	pinctrl_reg_usdhc3_vmmc: regusdhc3vmmcgrp {
+		fsl,pins = <
+			MX93_PAD_GPIO_IO17__GPIO2_IO17			0x31e
+		>;
+	};
+
 	pinctrl_usdhc3_wlan: usdhc3wlangrp {
 		fsl,pins = <
 			MX93_PAD_CCM_CLKO1__GPIO3_IO26			0x31e
+			MX93_PAD_GPIO_IO07__GPIO2_IO07			0x31e
+			/*MX93_PAD_GPIO_IO17__GPIO2_IO17			0x31e*/
 		>;
 	};
 
@@ -731,7 +751,7 @@
 		fsl,pins = <
 			MX93_PAD_GPIO_IO26__SAI3_TX_SYNC		0x31e
 			MX93_PAD_GPIO_IO16__SAI3_TX_BCLK		0x31e
-			MX93_PAD_GPIO_IO17__SAI3_MCLK		0x31e
+			/*MX93_PAD_GPIO_IO17__SAI3_MCLK		0x31e*/
 			MX93_PAD_GPIO_IO19__SAI3_TX_DATA00		0x31e
 			MX93_PAD_GPIO_IO20__SAI3_RX_DATA00		0x31e
 		>;
diff --git a/arch/arm64/configs/ucm-imx93_defconfig b/arch/arm64/configs/ucm-imx93_defconfig
index 69b87ea3c48a..b2a7e7d66552 100644
--- a/arch/arm64/configs/ucm-imx93_defconfig
+++ b/arch/arm64/configs/ucm-imx93_defconfig
@@ -346,6 +346,8 @@ CONFIG_USB_NET_MCS7830=m
 CONFIG_USB_NET_CDC_SUBSET=m
 CONFIG_USB_NET_ZAURUS=m
 CONFIG_HOSTAP=y
+CONFIG_MWIFIEX=m
+CONFIG_MWIFIEX_SDIO=m
 CONFIG_WL18XX=m
 CONFIG_WLCORE_SDIO=m
 CONFIG_XEN_NETDEV_BACKEND=m
-- 
2.17.1

